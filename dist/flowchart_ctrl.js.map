{"version":3,"sources":["../src/flowchart_ctrl.js"],"names":["MetricsPanelCtrl","_","unit","kbn","FlowChartCtrl","$scope","$injector","$rootScope","hiddenSeries","panelDefaults","forward","label","format","extendUnit","show","opposite","dataTemp","value","defaults","panel","events","on","onRender","bind","onDataReceived","onDataError","onInitEditMode","addEditorTab","unitFormats","getUnitFormats","subItem","type","formatValue","render","series","data","parseSeries","datapoints","length","checkSeries","targets","datapointsF","setData","datapointsO","hasOwnProperty","seriesData","dataList","map","seriesHandler","scope","elem","$panelContainer","find","$flowPanel","$panelContent","css","offsetHeight","templateUrl"],"mappings":"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","file":"flowchart_ctrl.js","sourcesContent":["import {MetricsPanelCtrl} from 'app/plugins/sdk';\nimport _ from 'lodash';\nimport unit from './unit';\nimport kbn from 'app/core/utils/kbn';\nimport './css/flow-panel.css!';\n\nexport class FlowChartCtrl extends MetricsPanelCtrl {\n\n  constructor($scope, $injector, $rootScope) {\n    super($scope, $injector);\n    this.$rootScope = $rootScope;\n    this.hiddenSeries = {};\n\n    var panelDefaults = {\n\t\t\tforward:{\n\t\t\t\tlabel: '流入',\n\t\t\t\tunit:'N/A',\n\t\t\t\tformat: 'short',\n\t\t\t\textendUnit: '',\n\t\t\t\tshow: true\n\t\t\t},\t\n\t\t\topposite:{\n\t\t\t\tlabel: '流出',\n\t\t\t\tunit:'N/A',\n\t\t\t\tformat: 'short',\n\t\t\t\textendUnit: '',\n\t\t\t\tshow: true\t\t  \n\t\t\t}\n\t\t};\n\t\t\n\t\tthis.dataTemp = {\n\t\t\tforward:{\n\t\t\t\tvalue: ''\n\t\t\t},\n\t\t\topposite:{\n\t\t\t\tvalue: ''\n\t\t\t}\n\t\t};\n\n    _.defaults(this.panel, panelDefaults);\n\n    this.events.on('render', this.onRender.bind(this));\n    this.events.on('data-received', this.onDataReceived.bind(this));\n    this.events.on('data-error', this.onDataError.bind(this));\n    this.events.on('data-snapshot-load', this.onDataReceived.bind(this));\n    this.events.on('init-edit-mode', this.onInitEditMode.bind(this));\n  }\n\n  onInitEditMode() {\n    this.addEditorTab('Options', 'public/plugins/grafana-flow-panel/editor.html', 2);\n    this.unitFormats = kbn.getUnitFormats();\n  }\n  \n  setUnitFormat(subItem, type) {\t\n\tif(type == 'forward'){\n\t\tthis.panel.forward.format = subItem.value;\n\t\tthis.dataTemp.forward.value = unit.formatValue(this.panel, this.dataTemp.forward.value, subItem.value);\n\t}else{\n\t\tthis.panel.opposite.format = subItem.value;\n\t\tthis.dataTemp.opposite.value = unit.formatValue(this.panel, this.dataTemp.opposite.value, subItem.value);\n\t}\n    this.render();\n  }\n\n  onDataError() {\n    this.series = [];\n    this.render();\n  }\n\n  onRender() {\n    this.data = this.parseSeries(this.series);\n  }\n  \n  setData(datapoints, panel, data){\n\t\tif(datapoints.length > 0){\n\t\t\tdata.value = datapoints[datapoints.length-1][0];\t\n\t\t\tdata.value = unit.formatValue(panel, data.value, panel.format);\n\t\t}else{\n\t\t\tdata.value = 'N/A';\n\t\t}\n  }\n\n  parseSeries(series) {\t  \n\t\tif(series && series.length > 0){\n\t\t\tseries = unit.checkSeries(this.panel.targets, series);\n\n\t\t\tif(this.panel.forward.show){ \n\t\t\t\tlet datapointsF = series[0].datapoints; \n\t\t\t\tthis.setData(datapointsF, this.panel.forward, this.dataTemp.forward);\n\t\t\t}\n\t\t\tif(this.panel.forward.show && this.panel.opposite.show){\n\t\t\t\tif(series[1] && series[1].datapoints){\n\t\t\t\t\tlet datapointsO = series[1].datapoints;  \n\t\t\t\t\tthis.setData(datapointsO, this.panel.opposite, this.dataTemp.opposite);\t\t\t\t\n\t\t\t\t}\n\t\t\t}\n\t\t\tif(!this.panel.forward.show && this.panel.opposite.show){\n\t\t\t\tlet datapointsO = series[0].datapoints;  \n\t\t\t\tthis.setData(datapointsO, this.panel.opposite, this.dataTemp.opposite);\t\n\t\t\t}\n\t\t}else{\n\t\t\tthis.setData([], this.panel.forward, this.dataTemp.forward);\n\t\t\tthis.setData([], this.panel.opposite, this.dataTemp.opposite);\n\t\t}\n\t\tthis.panel.forward.hasOwnProperty(\"value\") && delete this.panel.forward.value;\n\t\tthis.panel.opposite.hasOwnProperty(\"value\") && delete this.panel.opposite.value;\n\t\treturn this.dataTemp;\t\n  }\n  \n  seriesHandler(seriesData) {\n\t\treturn seriesData;\n  }\n\n  onDataReceived(dataList) {\n    this.series = dataList.map(this.seriesHandler.bind(this));\n    this.data = this.parseSeries(this.series);\n    this.render(this.data);\n  }\n  \n  link(scope, elem) {\n\t\tthis.events.on('render', () => {\n\t\t\tconst $panelContainer = elem.find('.panel-container');\n\t\t\tconst $flowPanel = elem.find('.flow-panel');\n\t\t\tconst $panelContent = elem.find('.panel-content');\n\t\t\t$panelContent.css('paddingLeft','0px');\n\t\t\t$panelContent.css('paddingRight','0px');\n\t\t\t$flowPanel.css('height', ($panelContainer[0].offsetHeight-40)+'px');\n\t\t});\n  }\n}\n\nFlowChartCtrl.templateUrl = 'module.html';\n"]}