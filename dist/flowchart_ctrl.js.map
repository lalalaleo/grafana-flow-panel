{"version":3,"sources":["../src/flowchart_ctrl.js"],"names":["MetricsPanelCtrl","_","kbn","FlowChartCtrl","$scope","$injector","$rootScope","hiddenSeries","panelDefaults","forward","label","unit","value","format","extendUnit","show","opposite","defaults","panel","events","on","onRender","bind","onDataReceived","onDataError","onInitEditMode","addEditorTab","unitFormats","getUnitFormats","subItem","type","formatValue","render","isNumber","decimals","scaledDecimals","delta","dec","Math","floor","log","LN10","magn","pow","norm","size","result","max","decimalInfo","getDecimalsForValue","formatFunc","valueFormats","series","data","parseSeries","targets","seriesFull","length","fillFlag","i","j","sLen","item","filter","target","push","splice","datapoints","checkSeries","datapointsF","setData","datapointsO","seriesData","dataList","map","seriesHandler","scope","elem","$panelContainer","find","$flowPanel","$panelContent","css","offsetHeight","templateUrl"],"mappings":"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","file":"flowchart_ctrl.js","sourcesContent":["import {MetricsPanelCtrl} from 'app/plugins/sdk';\nimport _ from 'lodash';\nimport kbn from 'app/core/utils/kbn';\nimport './css/flow-panel.css!';\n\nexport class FlowChartCtrl extends MetricsPanelCtrl {\n\n  constructor($scope, $injector, $rootScope) {\n    super($scope, $injector);\n    this.$rootScope = $rootScope;\n    this.hiddenSeries = {};\n\n    var panelDefaults = {\n\t  forward:{\n\t\t  label: '流入',\n\t\t  unit:'N/A',\n\t\t  value: '',\n\t\t  format: 'short',\n\t\t  extendUnit: '',\n\t\t  show: true\n\t  },\t\n\t  opposite:{\n\t\t  label: '流出',\n\t\t  unit:'N/A',\n\t\t  value: '',\n\t\t  format: 'short',\n\t\t  extendUnit: '',\n\t\t  show: true\t\t  \n\t  }\n    };\n\n    _.defaults(this.panel, panelDefaults);\n\n    this.events.on('render', this.onRender.bind(this));\n    this.events.on('data-received', this.onDataReceived.bind(this));\n    this.events.on('data-error', this.onDataError.bind(this));\n    this.events.on('data-snapshot-load', this.onDataReceived.bind(this));\n    this.events.on('init-edit-mode', this.onInitEditMode.bind(this));\n  }\n\n  onInitEditMode() {\n    this.addEditorTab('Options', 'public/plugins/grafana-flow-panel/editor.html', 2);\n    this.unitFormats = kbn.getUnitFormats();\n  }\n  \n  setUnitFormat(subItem, type) {\t\n\tif(type == 'forward'){\n\t\tthis.panel.forward.format = subItem.value;\n\t\tthis.panel.forward.value = this.formatValue(this.panel.forward.value, subItem.value);\n\t}else{\n\t\tthis.panel.opposite.format = subItem.value;\n\t\tthis.panel.opposite.value = this.formatValue(this.panel.opposite.value, subItem.value);\n\t}\n    this.render();\n  }\n  \n  getDecimalsForValue(value) {\n    if (_.isNumber(this.panel.decimals)) {\n      return { decimals: this.panel.decimals, scaledDecimals: null };\n    }\n\n    var delta = value / 2;\n    var dec = -Math.floor(Math.log(delta) / Math.LN10);\n\n    var magn = Math.pow(10, -dec);\n    var norm = delta / magn; // norm is between 1.0 and 10.0\n    var size;\n\n    if (norm < 1.5) {\n      size = 1;\n    } else if (norm < 3) {\n      size = 2;\n      // special case for 2.5, requires an extra decimal\n      if (norm > 2.25) {\n        size = 2.5;\n        ++dec;\n      }\n    } else if (norm < 7.5) {\n      size = 5;\n    } else {\n      size = 10;\n    }\n\n    size *= magn;\n\n    // reduce starting decimals if not needed\n    if (Math.floor(value) === value) { dec = 0; }\n\n    var result = {};\n    result.decimals = Math.max(0, dec);\n    result.scaledDecimals = result.decimals - Math.floor(Math.log(size) / Math.LN10) + 2;\n\n    return result;\n  }\n\n  formatValue(value, format) {\n    var decimalInfo = this.getDecimalsForValue(value);\n    var formatFunc = kbn.valueFormats[format];\n    if (formatFunc) {\n      return formatFunc(value, decimalInfo.decimals, decimalInfo.scaledDecimals);\n    }\n    return value;\n  }\n\n  onDataError() {\n    this.series = [];\n    this.render();\n  }\n\n  onRender() {\n    this.data = this.parseSeries(this.series);\n  }\n  \n  checkSeries(targets, series){\n\tlet seriesFull = [];\n\tif(targets.length == series.length){\n\t\treturn seriesFull = series;\n\t}else{\n\t\tlet fillFlag = false;\n\t\tfor(var i=0,length = targets.length; i<length; i++){\n\t\t\tfor(var j=0,sLen = series.length; j<sLen; j++){\n\t\t\t\tif(targets[i].item.filter == series[j].target){\n\t\t\t\t\tseriesFull.push(series[j]);\n\t\t\t\t\tfillFlag = false;\n\t\t\t\t\tbreak;\n\t\t\t\t}else{\n\t\t\t\t\tfillFlag = true;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif(fillFlag){\n\t\t\t\tif(targets[i].item && targets[i].item.filter){\n\t\t\t\t\tseriesFull.splice(i, 0, {'target':targets[i].item.filter, datapoints:[]});\n\t\t\t\t}else{\n\t\t\t\t\tseriesFull.splice(i, 0, {'target':'', datapoints:[]});\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\treturn seriesFull;\n  }\n  \n  setData(datapoints, panel){\n\tif(datapoints.length > 0){\n\t\tpanel.value = datapoints[datapoints.length-1][0];\t\n\t\tpanel.value = this.formatValue(panel.value, panel.format);\n\t}else{\n\t\tpanel.value = 'N/A';\n\t}\n  }\n\n  parseSeries(series) {\t  \n\tif(series && series.length > 0){\n\t\tseries = this.checkSeries(this.panel.targets, series);\n\t\tif(this.panel.forward.show){ \n\t\t\tlet datapointsF = series[0].datapoints; \n\t\t\tthis.setData(datapointsF, this.panel.forward);\n\t\t}\n\t\tif(this.panel.forward.show && this.panel.opposite.show){\n\t\t\tif(series[1] && series[1].datapoints){\n\t\t\t\tlet datapointsO = series[1].datapoints;  \n                this.setData(datapointsO, this.panel.opposite);\t\t\t\t\n\t\t\t}\n\t\t}\n\t\tif(!this.panel.forward.show && this.panel.opposite.show){\n\t\t\tlet datapointsO = series[0].datapoints;  \n\t\t\tthis.setData(datapointsO, this.panel.opposite);\t\n\t\t}\n\t}\n  }\n  \n  seriesHandler(seriesData) {\n\treturn seriesData;\n  }\n\n  onDataReceived(dataList) {\n    this.series = dataList.map(this.seriesHandler.bind(this));\n    this.data = this.parseSeries(this.series);\n    this.render(this.data);\n  }\n  \n  link(scope, elem) {\n\tthis.events.on('render', () => {\n\t    const $panelContainer = elem.find('.panel-container');\n\t    const $flowPanel = elem.find('.flow-panel');\n\t\tconst $panelContent = elem.find('.panel-content');\n\t\t$panelContent.css('paddingLeft','0px');\n\t\t$panelContent.css('paddingRight','0px');\n\t\t$flowPanel.css('height', ($panelContainer[0].offsetHeight-40)+'px');\n\t});\n  }\n}\n\nFlowChartCtrl.templateUrl = 'module.html';\n"]}